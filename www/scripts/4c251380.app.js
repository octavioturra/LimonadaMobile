"use strict";angular.module("limonadaApp",["ngResource","ngRoute","ngTouch","ngAnimate","underscore","channelData","snap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/category/:key",{templateUrl:"views/main.html",controller:"CategoryCtrl"}).when("/item/:key",{templateUrl:"views/Item.html",controller:"ItemCtrl"}).otherwise({redirectTo:"/"})}]).run(["Datamon","_","chData",function(a,b,c){b.globals("DATA_URL","data/data.json"),c.start(b.globals("DATA_URL"))}]);var eventName=1==!!window.device?"deviceready":"load";window.addEventListener(eventName,function(){_.publish("app.ready",{loaded:!0})}),angular.module("limonadaApp").service("Datamon",["$http","$q","_",function(a,b,c){!!c.globals("REMOTE_URL_CHANGESET")==!1&&(c.globals("REMOTE_URL_CHANGESET","./data/changeset.json"),c.globals("REMOTE_URL_DATA","./data/data.json"));var d=this;this.data=[];var e=-1,f=0,g=1,h=2,i=3,j=4;d.changeset={status:e,local:null,remote:null},d.start=function(a){if("function"!=typeof a)throw new Error("Incompatible callback function");d.cb=a,c.publish("changeset.initialize")},d.localChangesetLoad=function(){c.local().getData("changeset",function(a,b){a.publish("changeset.loaded",{key:"local",content:b[0]})})},d.remoteChangesetLoad=function(){a.get(c.globals("REMOTE_URL_CHANGESET")).success(function(a){a.success===!1&&c.publish("changeset.fail",{action:"remote",message:a.message}),c.publish("changeset.loaded",{key:"remote",content:a.data})}).error(function(){c.publish("changeset.fail",{action:"remote",message:"Impossible to reach changeset data"})})},d.prepareChangeset=function(a){return d.changeset[a.key]=a.content,d.changeset.status===f||d.changeset.status===j?(d.changeset.status=g,g):d.changeset.status===g?(d.changeset.status=h,h):void 0},d.loadRemoteDataToLocal=function(b){if("function"!=typeof b)throw new Error("Wrong or empty callback function");a.get(c.globals("REMOTE_URL_DATA")).success(function(a){if(a.success===!1)throw new Error(a.message);d.data=a,c.local().setData("data",a.data,function(){b()})}).error(function(){throw new Error("Impossible to reach data")})},d.loadDataToContainer=function(){c.local().getData("data",function(a,b){if(!!b==!1)throw new Error("Wrong local data container content");if(1!==b.length)throw new Error("Empty data content");d.cb(b[0]),a.publish("data.loaded",b[0])})},d.reload=function(){d.loadDataToContainer.apply(this,arguments)},c.subscribe("changeset",function(){}),c.subscribe("changeset.initialize",function(){var a=function(){d.localChangesetLoad(),d.remoteChangesetLoad()};switch(d.changeset.status){case e:d.changeset.status=f,a();break;case i:d.changeset.status=j,a();break;case j:throw new Error("Impossible to load changeset")}}),c.subscribe("changeset.loaded",function(a,b){if(!!b==!1)return c.publish("changeset.fail");if(!!b.key==!1)return c.publish("changeset.fail");var e=d.prepareChangeset(b);return e===h?c.publish("changeset.complete"):void 0}),c.subscribe("changeset.fail",function(){d.changeset.status=i}),c.subscribe("changeset.complete",function(){d.changeset.remote!==d.changeset.local?c.publish("data.outdated"):c.publish("data.updated")}),c.subscribe("data",function(){}),c.subscribe("data.outdated",function(){d.loadRemoteDataToLocal(function(){c.local().setData("changeset",d.changeset.remote,function(){c.publish("data.updated")})})}),c.subscribe("data.updated",function(){d.loadDataToContainer()})}]),angular.module("limonadaApp").service("Search",function(){this.searchByFuzzy=function(){},this.searchByKey=function(){}}),angular.module("limonadaApp").controller("MainCtrl",["$scope","chData","_","$routeParams",function(a,b){a.data=[],b.reload(),a.snapOpts={disable:"right",addBodyClasses:"snapped",minPosition:"8px"}}]),angular.module("limonadaApp").controller("CategoryCtrl",["$scope","chData","_","$route",function(a,b,c){b.reload(),c.subscribe("data.loaded",function(b,d){var e=c.pluck(d,"category");a.categories=c.uniq(e),a.$digest()})}]),angular.module("limonadaApp").controller("ItemCtrl",["$scope","chData","_","$route",function(a,b,c,d){var e=d.current.params.key;b.reload(),c.subscribe("data.loaded",function(b,d){var f=c(d).findWhere({key:e});a.item=f,console.log(e,f),a.$digest()})}]),angular.module("limonadaApp").controller("NavbarCtrl",["$scope","Datamon",function(a){a.categories=[],_.subscribe("data.loaded",function(b,c){var d=_.pluck(c,"category");a.categories=_.uniq(d),a.$digest()})}]);