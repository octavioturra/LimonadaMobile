"use strict";angular.module("limonadaApp",["ngResource","ngRoute","ngTouch","ngAnimate","underscore","channelData","snap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/category/:key",{templateUrl:"views/main.html",controller:"CategoryCtrl"}).when("/item/:key",{templateUrl:"views/Item.html",controller:"ItemCtrl"}).otherwise({redirectTo:"/"})}]).run(["Datamon","_","chData",function(a,b,c){b.globals("DATA_URL","data/data.json"),c.start(b.globals("DATA_URL"))}]),window.addEventListener("load",function(){_.publish("app.ready",{loaded:!0})}),angular.module("limonadaApp").service("Datamon",["$http","$q","_",function(a,b,c){!!c.globals("REMOTE_URL_CHANGESET")==!1&&(c.globals("REMOTE_URL_CHANGESET","./data/changeset.json"),c.globals("REMOTE_URL_DATA","./data/data.json"));var d=this;this.data=[];var e=-1,f=0,g=1,h=2,i=3,j=4;d.changeset={status:e,local:null,remote:null},d.start=function(a){if("function"!=typeof a)throw new Error("Incompatible callback function");d.cb=a,c.publish("changeset.initialize")},d.localChangesetLoad=function(){c.local().getData("changeset",function(a,b){a.publish("changeset.loaded",{key:"local",content:b[0]})})},d.remoteChangesetLoad=function(){a.get(c.globals("REMOTE_URL_CHANGESET")).success(function(a){a.success===!1&&c.publish("changeset.fail",{action:"remote",message:a.message}),c.publish("changeset.loaded",{key:"remote",content:a.data})}).error(function(){c.publish("changeset.fail",{action:"remote",message:"Impossible to reach changeset data"})})},d.prepareChangeset=function(a){return d.changeset[a.key]=a.content,d.changeset.status===f||d.changeset.status===j?(d.changeset.status=g,g):d.changeset.status===g?(d.changeset.status=h,h):void 0},d.loadRemoteDataToLocal=function(b){if("function"!=typeof b)throw new Error("Wrong or empty callback function");a.get(c.globals("REMOTE_URL_DATA")).success(function(a){if(a.success===!1)throw new Error(a.message);d.data=a,c.local().setData("data",a.data,function(){b()})}).error(function(){throw new Error("Impossible to reach data")})},d.loadDataToContainer=function(){c.local().getData("data",function(a,b){if(!!b==!1)throw new Error("Wrong local data container content");if(1!==b.length)throw new Error("Empty data content");d.cb(b[0]),a.publish("data.loaded",b[0])})},d.reload=function(){d.loadDataToContainer.apply(this,arguments)},c.subscribe("changeset",function(){}),c.subscribe("changeset.initialize",function(){var a=function(){d.localChangesetLoad(),d.remoteChangesetLoad()};switch(d.changeset.status){case e:d.changeset.status=f,a();break;case i:d.changeset.status=j,a();break;case j:throw new Error("Impossible to load changeset")}}),c.subscribe("changeset.loaded",function(a,b){if(!!b==!1)return c.publish("changeset.fail");if(!!b.key==!1)return c.publish("changeset.fail");var e=d.prepareChangeset(b);return e===h?c.publish("changeset.complete"):void 0}),c.subscribe("changeset.fail",function(){d.changeset.status=i}),c.subscribe("changeset.complete",function(){d.changeset.remote!==d.changeset.local?c.publish("data.outdated"):c.publish("data.updated")}),c.subscribe("data",function(){}),c.subscribe("data.outdated",function(){d.loadRemoteDataToLocal(function(){c.local().setData("changeset",d.changeset.remote,function(){c.publish("data.updated")})})}),c.subscribe("data.updated",function(){d.loadDataToContainer()})}]),angular.module("limonadaApp").service("Search",function(){this.searchByFuzzy=function(){},this.searchByKey=function(){}}),angular.module("limonadaApp").controller("MainCtrl",["$scope","chData","_","$routeParams",function(a,b,c){a.data=[],b.reload(),c.subscribe("data.loaded",function(b,d){var e=c.pluck(d,"category");a.categories=c.uniq(e),a.$digest()}),a.snapOpts={disable:"right",addBodyClasses:"snapped",minPosition:"8px"}}]),angular.module("limonadaApp").controller("CategoryCtrl",["$scope","chData","_","$route",function(a,b,c,d){a.key=d.current.params.key,b.reload()}]),angular.module("limonadaApp").controller("ItemCtrl",["$scope","chData","_","$route",function(a,b,c,d){var e=d.current.params.key;b.reload(),c.subscribe("data.loaded",function(b,d){var f=c(d).findWhere({key:e});a.item=f,console.log(e,f),a.$digest()})}]),angular.module("limonadaApp").controller("NavbarCtrl",["$scope","Datamon",function(a){a.categories=[],_.subscribe("data.loaded",function(b,c){var d=_.pluck(c,"category");a.categories=_.uniq(d),a.$digest()})}]),angular.module("channelData",["underscore"]).directive("chSubscribe",function(){return{template:"<div ng-transclude></div>",transclude:!0,link:function(a,b,c){var d=(c.chSubscribe||"").split("|"),e={event:"broadcast",data:"data"};1==d.length?e.event=d[0].trim():2==d.length&&(e.event=d[0].trim(),e.container=d[1].trim()),_.subscribe(e.event,function(b,c){a.label=b,a[e.data]=c,a.$digest()})}}}),angular.module("channelData").factory("chData",["_","chHttp",function(a,b){function c(){}var d,e=0,f=1;c.prototype.start=function(b){d=b,a.publish("changeset.start")},c.prototype.reload=function(){!!d==!1&&a.publish("data.fail","Empty URL"),a.publish("changeset.start")},c.prototype.loadChangeset=function(){a.local().getData("changeset",function(a,b){!!b==!1?(a.publish("changeset.empty"),a.publish("changeset.loaded",0)):a.publish("changeset.loaded",b)})},c.prototype.processDataFromServer=function(b){!!b==!1?a.publish("data.fail","Empty data result."):b.success===!1&&a.publish("data.fail","Error:"+b.message),b.data.state===f?a.publish("data.update"):b.data.state===e?a.publish("data.outdate",{changeset:b.data.changeset,content:b.data.content}):a.publish("data.fail","Wrong state.")},c.prototype.loadFromServer=function(c){var e=this;b.get(d,{changeset:c}).then(function(a){e.processDataFromServer(a)},function(b){a.publish("data.fail","Error:"+b)})},c.prototype.update=function(b){a.local().setData("changeset",b.changeset,"data",b.content,function(){a.publish("data.update")})},c.prototype.loadFromLocal=function(){a.local().getData("data",function(a,b){!!b==!1?a.publish("data.fail","Empty data container."):a.publish("data.loaded",b.length>0?b[0]:[])})};var g=new c;return a.subscribe("changeset"),a.subscribe("changeset.start",function(){g.loadChangeset()}),a.subscribe("changeset.empty"),a.subscribe("changeset.loaded",function(b,c){a.publish("data.start",c)}),a.subscribe("data"),a.subscribe("data.start",function(a,b){g.loadFromServer(b)}),a.subscribe("data.fail",console.log),a.subscribe("data.outdate",function(a,b){g.update(b)}),a.subscribe("data.update",function(){g.loadFromLocal()}),a.subscribe("data.loaded"),window.channelData=g,g}]),angular.module("channelData").factory("chHttp",["$http","$q",function(a,b){var c=b.defer();return{get:function(b){return c.notify("Data loading"),a.get(b).success(function(a){c.resolve(a)}).error(function(a){c.resolve(a)}),c.promise}}}]);