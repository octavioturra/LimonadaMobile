"use strict";angular.module("channelData",["underscore"]).directive("chSubscribe",function(){return{template:"<div ng-transclude></div>",transclude:!0,link:function(a,b,c){var d=(c.chSubscribe||"").split("|"),e={event:"broadcast",data:"data"};1==d.length?e.event=d[0].trim():2==d.length&&(e.event=d[0].trim(),e.container=d[1].trim()),_.subscribe(e.event,function(b,c){a.label=b,a[e.data]=c,a.$digest()})}}}),angular.module("channelData").factory("chData",["_","chHttp",function(a,b){function c(){}var d,e=0,f=1;c.prototype.start=function(b){d=b,a.publish("changeset.start")},c.prototype.reload=function(){!!d==!1&&a.publish("data.fail","Empty URL"),a.publish("changeset.start")},c.prototype.loadChangeset=function(){a.local().getData("changeset",function(a,b){!!b==!1?(a.publish("changeset.empty"),a.publish("changeset.loaded",0)):a.publish("changeset.loaded",b)})},c.prototype.processDataFromServer=function(b){!!b==!1?a.publish("data.fail","Empty data result."):b.success===!1&&a.publish("data.fail","Error:"+b.message),b.data.state===f?a.publish("data.update"):b.data.state===e?a.publish("data.outdate",{changeset:b.data.changeset,content:b.data.content}):a.publish("data.fail","Wrong state.")},c.prototype.loadFromServer=function(c){var e=this;b.get(d,{changeset:c}).then(function(a){e.processDataFromServer(a)},function(b){a.publish("data.fail","Error:"+b)})},c.prototype.update=function(b){a.local().setData("changeset",b.changeset,"data",b.content,function(){a.publish("data.update")})},c.prototype.loadFromLocal=function(){a.local().getData("data",function(a,b){!!b==!1?a.publish("data.fail","Empty data container."):a.publish("data.loaded",b.length>0?b[0]:[])})};var g=new c;return a.subscribe("changeset"),a.subscribe("changeset.start",function(){g.loadChangeset()}),a.subscribe("changeset.empty"),a.subscribe("changeset.loaded",function(b,c){a.publish("data.start",c)}),a.subscribe("data"),a.subscribe("data.start",function(a,b){g.loadFromServer(b)}),a.subscribe("data.fail",console.log),a.subscribe("data.outdate",function(a,b){g.update(b)}),a.subscribe("data.update",function(){g.loadFromLocal()}),a.subscribe("data.loaded"),window.channelData=g,g}]),angular.module("channelData").factory("chHttp",["$http","$q",function(a,b){var c=b.defer();return{get:function(b){return c.notify("Data loading"),a.get(b).success(function(a){c.resolve(a)}).error(function(a){c.resolve(a)}),c.promise}}}]);